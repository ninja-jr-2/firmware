name: Ninja-Jr Build (T-Embed CC1101)

on:
  workflow_dispatch:
    inputs:
      target_branch:
        description: 'Branch to build from'
        required: true
        default: 'dev'
        type: string
      version_name:
        description: 'Version name (Ninja-Jr 1.0, Ninja-Jr dev, etc)'
        required: true
        default: 'Ninja-Jr dev'
        type: string

jobs:
  compile_sketch:
    name: Build lilygo-t-embed-cc1101
    runs-on: ubuntu-latest
    env:
      BOARD_ENV: "lilygo-t-embed-cc1101"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.target_branch }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install build deps (multilib)
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends gcc-multilib libc6-dev-i386

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          pip install requests esptool intelhex

      - name: Cache PlatformIO
        uses: actions/cache@v4
        with:
          path: ~/.platformio
          key: Bruce-platformio-${{ hashFiles('**/platformio.ini') }}
          restore-keys: Bruce-platformio-

      - name: Restore PIO Build Cache
        uses: actions/cache/restore@v4
        with:
          path: ${{ github.workspace }}/.pio
          key: Bruce-pio-${{ env.BOARD_ENV }}-${{ github.run_id }}-${{ github.run_attempt }}
          restore-keys: |
            Bruce-pio-${{ env.BOARD_ENV }}-

      - name: Install PlatformIO and configure version
        run: |
          pip install platformio
          sed -i "s/-DBRUCE_VERSION=/-DBRUCE_VERSION='\"${{ github.event.inputs.version_name }}\"' ; /g" ./platformio.ini
          GIT_HASH=$(git describe --always --dirty)
          sed -i "s|-DGIT_COMMIT_HASH='\"Homebrew\"'|!echo '-DGIT_COMMIT_HASH=\\\\\\\\\"${GIT_HASH}\\\\\\\\\"'|g" ./platformio.ini

      - name: Compile for lilygo-t-embed-cc1101
        run: |
          platformio run -e ${{ env.BOARD_ENV }}

      - name: Save PIO Build Cache
        uses: actions/cache/save@v4
        with:
          path: ${{ github.workspace }}/.pio
          key: Bruce-pio-${{ env.BOARD_ENV }}-${{ github.run_id }}-${{ github.run_attempt }}

      - name: Upload Binary Artifact
        uses: actions/upload-artifact@v4
        with:
          name: Bruce-${{ env.BOARD_ENV }}-${{ github.event.inputs.version_name }}
          path: |
            Bruce-*.bin
            Bruce-*.elf
            Bruce-*.map
          retention-days: 30
          if-no-files-found: error

      - name: Display Build Info
        run: |
          echo "Build completed successfully!"
          echo "Environment: ${{ env.BOARD_ENV }}"
          echo "Version: ${{ github.event.inputs.version_name }}"
          echo "Git Hash: $(git describe --always --dirty)"
          ls -la Bruce-*.* 2>/dev/null || echo "No Bruce files found"
